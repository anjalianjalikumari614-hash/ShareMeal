<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donor Home | ShareMeal</title>

    <!-- Google Fonts: 'Outfit' for headings, 'Inter' for body -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/style.css?v=2">
</head>

<body>

    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container nav-container">
            <a href="#" class="logo">Share<span class="highlight">Meal</span></a>
            <ul class="nav-links">
                <li><a href="#" class="active">Home</a></li>
                <!-- Replaced Find Food with Recent Feed for Donors -->
                <li><a href="/donor">My Dashboard</a></li>
                <li><a href="#recent-activity">Recent Activity</a></li>
                <li><a href="/donor" id="profileLink">Profile</a></li>
                <li><a href="#" onclick="logout()" class="btn-login" style="background: #e74c3c;">Logout</a></li>
            </ul>
            <div class="mobile-toggle">
                <i class="fa-solid fa-bars"></i>
            </div>
        </div>
    </nav>

    <!-- ACTIVE EMERGENCY ALERT SECTION -->
    <div id="emergency-alert-section" class="container"
        style="display:none; margin-top: 100px; margin-bottom: -60px; position:relative; z-index:5;">
        <div
            style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: 12px; padding: 20px; color: white;">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <div>
                    <h2 id="embTitle" style="color: #ef4444; margin-bottom:10px;"><i
                            class="fa-solid fa-triangle-exclamation"></i> Emergency Alert</h2>
                    <p id="embDesc" style="font-size: 1.1rem; margin-bottom: 20px;">Loading...</p>

                    <div style="display:flex; gap:20px; flex-wrap:wrap;">
                        <span
                            style="background:rgba(239, 68, 68, 0.2); padding:5px 10px; border-radius:6px; color:#fca5a5;">
                            <i class="fa-solid fa-location-dot"></i> <strong id="embArea">Area</strong>
                        </span>
                        <span
                            style="background:rgba(239, 68, 68, 0.2); padding:5px 10px; border-radius:6px; color:#fca5a5;">
                            <i class="fa-solid fa-phone"></i> <strong id="embContact">Contact</strong>
                        </span>
                    </div>
                </div>
                <a href="/donate-emergency" class="btn"
                    style="background: #ef4444; color: white; border:none; white-space:nowrap;">
                    <i class="fa-solid fa-hand-holding-medical"></i> Donate Now
                </a>
            </div>
        </div>
    </div>

    <!-- Hero Section -->
    <header class="hero">
        <div class="container hero-container">
            <div class="hero-content">
                <div class="badge">Welcome back, <span id="donorNameDisplay">Donor</span></div>
                <h1>Ready to Share <br><span class="gradient-text">More Meals?</span></h1>
                <p>Your contributions have already helped many. Continue to bridge the gap between surplus and hunger.
                </p>
                <div class="hero-buttons">
                    <a href="/donate" class="btn btn-primary"><i class="fa-solid fa-hand-holding-heart"></i> Donate
                        Food</a>
                    <a href="/donor" class="btn btn-secondary">View My History</a>
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <span class="stat-number" id="statsMeals">0</span>
                        <span class="stat-label">Meals Donated</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">Active</span>
                        <span class="stat-label">Donor Status</span>
                    </div>
                </div>
            </div>
            <div class="hero-image">
                <div class="glowing-circle"></div>
                <div class="card-float donor-card">
                    <i class="fa-solid fa-heart"></i>
                    <div>
                        <strong>You are amazing!</strong>
                        <small>Keep up the good work</small>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Recent Activity Section (Replacing Find Food conceptually) -->
    <section id="recent-activity" class="features">
        <div class="container">
            <h2 class="section-title">Community Impact</h2>
            <div id="activityGrid" class="features-grid"
                style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                <!-- Content injected via JS -->
                <div class="loading-state">
                    <p>Loading recent community activity...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Profile Script -->
    <script>
        const userStr = localStorage.getItem('user');
        if (!userStr) {
            window.location.href = '/login';
        }
        const user = JSON.parse(userStr);

        // Update UI with User Name
        document.getElementById('donorNameDisplay').innerText = user.name;

        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Fetch Recent Donations for "Community Impact"
        async function fetchRecentActivity() {
            try {
                const response = await fetch('/api/donations');
                const donations = await response.json();
                const container = document.getElementById('activityGrid');
                container.innerHTML = '';

                // Show last 3 donations from anyone
                const recent = donations.slice(0, 3);

                if (recent.length === 0) {
                    container.innerHTML = '<p>No recent activity.</p>';
                    return;
                }

                recent.forEach(d => {
                    const card = document.createElement('div');
                    card.className = 'feature-card';
                    card.style.textAlign = 'left';
                    card.innerHTML = `
                        <div class="icon-box"><i class="fa-solid fa-utensils"></i></div>
                        <h3>${d.food_type.replace('_', ' ')}</h3>
                        <p>${d.quantity} servings donated by ${d.pickup_address}</p>
                        <small style="color: var(--primary-color); font-weight:bold;">${d.status}</small>
                    `;
                    container.appendChild(card);
                });

            } catch (err) {
                console.error(err);
            }
        }

        fetchRecentActivity();
        fetchRecentActivity();
        fetchStats();
        fetchEmergencyForPage();

        async function fetchEmergencyForPage() {
            try {
                const res = await fetch('/api/broadcast/active');
                const data = await res.json();

                if (data && data.status === 'Active') {
                    const section = document.getElementById('emergency-alert-section');
                    section.style.display = 'block';

                    document.getElementById('embTitle').innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ${data.title}`;
                    document.getElementById('embDesc').innerText = data.description;
                    document.getElementById('embArea').innerText = data.area;
                    document.getElementById('embContact').innerText = data.contact_details;

                    // Adjust Hero padding a bit since we inserted content above it
                    document.querySelector('.hero').style.paddingTop = '60px';
                }
            } catch (e) { console.error('Error fetching emergency for page:', e); }
        }

        async function fetchStats() {
            try {
                const res = await fetch(`/api/user/stats/${user.id}`);
                if (res.ok) {
                    const stats = await res.json();
                    const mealDisplay = document.getElementById('statsMeals');
                    if (mealDisplay) mealDisplay.innerText = stats.meals_donated;
                }
            } catch (e) { console.error('Error fetching stats:', e); }
        }
    </script>
    </script>
    <script src="/app.js?v=5"></script>
</body>

</html>